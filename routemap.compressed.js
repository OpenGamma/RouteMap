(function(C,D){(function(a,b){if(!a.every||!a.filter||!a.indexOf||!a.map||!a.reduce||!a.some||!a.forEach)throw Error("See "+b+" for reference versions of Array.prototype methods available in JS 1.8");})([],"https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/array/");var o,l={},t={},r=[],y=0,v=0,z=encodeURIComponent,A=decodeURIComponent,u="#",E=/\*|:|\?/,F=/(^([^\*:\?]+):\*)|(^\*$)/,G=/^:([^\*:\?]+)(\??)$/,H=/^([^\*:\?]+):(\??)$/,I=/([^\/])$/,w=typeof window!=="undefined"?window:
{},p=function(a){return typeof a!=="string"||!a.length},B=function(a){var b=r.filter(function(c){return~a.replace(I,"$1/").indexOf(c)}).filter(function(c,d){return!d||l[c].some(function(e){return!!e.rules.star})});return!b.length?[]:b.reduce(function(c,d){var e=l[d].map(function(h){var f={},j=h.rules.scalars,k=h.rules.keyvals,q,i=a.replace(d,"").split("/").reduce(function(g,m){var s=m.split("="),J=s[0];s=s.slice(1).join("=");return!m.length||(s?g.keyvals[J]=s:g.scalars.push(m)),g},{keyvals:{},scalars:[]}),
n,K=k.reduce(function(g,m){return(g[m.name]=0)||g},{}),L=j.filter(function(g){return g.required}).length,M=k.filter(function(g){return g.required}).every(function(g){return i.keyvals.hasOwnProperty(g.name)});if(L>i.scalars.length||!M)return 0;if(!h.rules.star){if(i.scalars.length>j.length)return 0;for(n in i.keyvals)if(i.keyvals.hasOwnProperty(n)&&!K.hasOwnProperty(n))return 0}i.scalars.slice(0,j.length).forEach(function(g,m){f[j[m].name]=A(g)});k.forEach(function(g){if(i.keyvals[g.name])f[g.name]=
A(i.keyvals[g.name]);delete i.keyvals[g.name]});if(h.rules.star){k=i.scalars.slice(j.length,i.scalars.length);for(n in i.keyvals)i.keyvals.hasOwnProperty(n)&&k.push([n,i.keyvals[n]].join("="));f[h.rules.star]=k.join("/")}try{q=h.method.split(".").reduce(function(g,m){return g[m]},w);if(typeof q!=="function")throw Error();}catch(N){throw new TypeError("parse: "+h.method+" is not a function in current context");}return{page:d,hash:o.hash({route:h.raw},f),method:q,args:f}});return c.concat(e).filter(Boolean)},
[]).sort(function(c,d){return d.hash.length-c.hash.length})},x=function(a){return function(b){var c,d={},e=b[0]==="/"?b:~(c=b.indexOf("/"))?b.slice(c):0,h=function(f){if(d.hasOwnProperty(f)||(d[f]=0))throw new SyntaxError('compile: "'+f+'" is repeated in: '+b);};if(!e)throw new SyntaxError("compile: the route "+b+" was not understood");if(a[e])return a[e];c=e.split("/").reduce(function(f,j){var k=f.rules,q=k.scalars,i=k.keyvals;if(k.star)throw new SyntaxError("compile: no rules can follow a * directive in: "+
b);if(!~j.search(E)&&!q.length&&!i.length)return f.page.push(j),f;if(j.match(F))return k.star=RegExp.$2||RegExp.$3,h(k.star),f;if(j.match(G)){if(f.has_optional_scalar)throw new SyntaxError('compile: "'+j+'" cannot follow an optional rule in: '+b);if(RegExp.$2)f.has_optional_scalar=j;return q.push({name:RegExp.$1,required:!RegExp.$2}),h(RegExp.$1),f}if(j.match(H))return i.push({name:RegExp.$1,required:!RegExp.$2}),h(RegExp.$1),f;throw new SyntaxError('compile: the rule "'+j+'" was not understood in: '+
b);},{page:[],rules:{scalars:[],keyvals:[],star:false},has_optional_scalar:""});delete c.has_optional_scalar;c.page=c.page.join("/").replace(/\/$/,"")||"/";return a[e]=c}}({});C[D]=o={add:function(a){var b=a.method,c=a.route,d=[a.method,a.route].join("|");if([c,b].some(p))throw new TypeError("add: rule.route and rule.method must both be non-empty strings");if(t[d])throw Error("add: "+c+" to "+b+" already exists");a=x(c);t[d]=true;if(!l[a.page]&&(l[a.page]=[]))r=r.concat(a.page).sort(function(e,h){return h.length-
e.length});l[a.page].push(o.post_add({method:b,rules:a.rules,raw:c}))},context:function(a){return w=typeof a==="object"?a:w},current:function(){return v},default_handler:function(){},get:function(){if(typeof window==="undefined")return"/";var a=window.location.hash,b=a.indexOf("/");return~b?a.slice(b):"/"},go:function(a){if(typeof window!=="undefined")window.location.hash=(a.indexOf(u)===0?"":u)+a},handler:function(){var a=o.get(),b=B(a),c=Array.prototype.slice.call(arguments);if(!b.length)return o.default_handler.apply(null,
[a].concat(c));v=b[0];b=o.pre_dispatch(b);v=b[0];b.forEach(function(d){d.method.apply(null,[d.args].concat(c))});y=b[0]},hash:function(a,b){var c,d;b=b||{};if(p(a.route))throw new TypeError("hash: rule.route must be a non-empty string");d=x(a.route);c=d.page+(d.page==="/"?"":"/")+d.rules.scalars.map(function(e){var h=z(b[e.name]),f=b[e.name]===void 0||p(h);if(e.required&&f)throw new TypeError("hash: params."+e.name+" is undefined, route: "+a.route);return f?0:h}).concat(d.rules.keyvals.map(function(e){var h=
z(b[e.name]),f=b[e.name]===void 0||p(h);if(e.required&&f)throw new TypeError("hash: params."+e.name+" is undefined, route: "+a.route);return f?0:e.name+"="+h})).filter(Boolean).join("/");if(d.rules.star&&b[d.rules.star])c+=(c[c.length-1]==="/"?"":"/")+b[d.rules.star];return c},last:function(){return y},parse:function(a){var b;b=a.indexOf("/");a=~b?a.slice(b):"";if(p(a))throw new TypeError("parse: hash must be a string with a / character");if(!(b=B(a)).length)throw new SyntaxError("parse: "+a+" cannot be parsed");
return{page:b[0].page,args:b[0].args}},post_add:function(a){return a},pre_dispatch:function(a){return a},prefix:function(a){return u=typeof a!=="undefined"?a+"":u},remove:function(a){var b=a.method,c=a.route,d=[a.method,a.route].join("|");if([c,b].some(p))throw new TypeError("remove: rule.route and rule.method must both be non-empty strings");if(t[d]){a=x(c);delete t[d];l[a.page]=l[a.page].filter(function(e){return e.raw!==c||e.method!==b});if(!l[a.page].length&&delete l[a.page])if(~(a=r.indexOf(a.page)))r.splice(a,
1)}}}})(typeof exports==="undefined"?window:exports,"RouteMap");
