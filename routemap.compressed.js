(function(D,E){(function(a,b){if(!a.every||!a.filter||!a.indexOf||!a.map||!a.reduce||!a.some)throw Error("See "+b+" for reference versions of Array.prototype methods available in JS 1.8");})([],"https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/array/");var n,j={},s={},q=[],x=0,u=0,y=encodeURIComponent,z=decodeURIComponent,t="#",F=/\*|:|\?/,G=/(^([^\*:\?]+):\*)|(^\*$)/,H=/^:([^\*:\?]+)(\??)$/,I=/^([^\*:\?]+):(\??)$/,A=/([^\/])$/,B=typeof window!=="undefined"?window:{},o=function(a){return typeof a!==
"string"||!a.length},C=function(a){var b=q.filter(function(d){A.exec(a);return~a.replace(A,RegExp.$1+"/").indexOf(d)}).filter(function(d,c){return!c||j[d].some(function(e){return!!e.rules.star})});return!b.length?[]:b.reduce(function(d,c){var e=j[c].map(function(f){var h={},l=f.rules.scalars,p=f.rules.keyvals,v,i=a.replace(c,"").split("/").reduce(function(g,k){var r=k.split("="),J=r[0];r=r.slice(1).join("=");return!k.length||(r?g.keyvals[J]=r:g.scalars.push(k)),g},{keyvals:{},scalars:[]}),m,K=p.reduce(function(g,
k){return(g[k.name]=0)||g},{}),L=l.filter(function(g){return g.required}).length,M=p.filter(function(g){return g.required}).every(function(g){return g.name in i.keyvals});if(L>i.scalars.length||!M)return 0;if(!f.rules.star){if(i.scalars.length>l.length)return 0;for(m in i.keyvals)if(i.keyvals.hasOwnProperty(m)&&!(m in K))return 0}i.scalars.slice(0,l.length).forEach(function(g,k){h[l[k].name]=z(g)});p.forEach(function(g){if(i.keyvals[g.name])h[g.name]=z(i.keyvals[g.name]);delete i.keyvals[g.name]});
if(f.rules.star){p=i.scalars.slice(l.length,i.scalars.length);for(m in i.keyvals)i.keyvals.hasOwnProperty(m)&&p.push([m,i.keyvals[m]].join("="));h[f.rules.star]=p.join("/")}try{v=f.method.split(".").reduce(function(g,k){return g[k]},B);if(typeof v!=="function")throw Error();}catch(N){throw new TypeError("parse: "+f.method+" is not a function");}return{page:c,hash:n.hash({route:f.raw},h),method:v,args:h}});return d.concat(e).filter(Boolean)},[]).sort(function(d,c){return c.hash.length-d.hash.length})},
w=function(){var a={};return function(b){var d;d=b;b=b[0]==="/"?b:~b.indexOf("/")?b.slice(b.indexOf("/")):null;if(!b)throw new SyntaxError('compile: the route "'+d+'" was not understood');if(b in a)return a[b];d=b.split("/").reduce(function(c,e){var f=c.rules,h=f.scalars,l=f.keyvals;if(f.star)throw new SyntaxError("compile: no rules can follow a * directive");if(!~e.search(F)&&!h.length&&!l.length)return c.page.push(e),c;if(e.match(G))return f.star=RegExp.$2||RegExp.$3,c;if(e.match(H)){if(!RegExp.$2&&
c.last_optional)throw new SyntaxError('compile: "'+e+'" cannot follow an optional rule');if(RegExp.$2)c.last_optional=e;return h.push({name:RegExp.$1,required:!RegExp.$2}),c}if(e.match(I))return l.push({name:RegExp.$1,required:!RegExp.$2}),c;throw new SyntaxError('compile: the rule "'+e+'" was not understood');},{page:[],rules:{scalars:[],keyvals:[],star:false},last_optional:""});delete d.last_optional;d.page=d.page.join("/").replace(/\/$/,"")||"/";return a[b]=d}}();return D[E]=n={add:function(a){var b=
a.method,d=a.route,c=[a.method,a.route].join("|");if([d,b].some(o))throw new TypeError("add: rule.route and rule.method must both be non-empty strings");if(c in s)throw Error("add: "+d+" to "+b+" already exists");a=w(d);s[c]=0;if(!j[a.page]&&(j[a.page]=[]))q=q.concat(a.page).sort(function(e,f){return f.length-e.length});j[a.page].push(n.post_add({method:b,rules:a.rules,raw:d}))},context:function(a){if(a)B=a;else throw new TypeError("context: scope is falsey");},current:function(){return u},default_handler:function(){},
get:function(){if(typeof window==="undefined")return"/";var a=window.location.hash,b=a.indexOf("/");return~b?a.slice(b):"/"},go:function(a){if(typeof window!=="undefined")window.location.hash=(a.indexOf(t)===0?"":t)+a},handler:function(){var a=n.get(),b=C(a),d=Array.prototype.slice.call(arguments);if(!b.length)return n.default_handler.apply(null,[a].concat(d));u=b[0];b=n.pre_dispatch(b);u=b[0];b.forEach(function(c){c.method.apply(null,[c.args].concat(d))});x=b[0]},hash:function(a,b){var d,c;b=b||
{};if(o(a.route))throw new TypeError("hash: rule.route must be a non-empty string");c=w(a.route);d=c.page+(c.page==="/"?"":"/")+c.rules.scalars.map(function(e){var f=y(b[e.name]),h=b[e.name]===void 0||o(f);if(e.required&&h)throw new TypeError("hash: params."+e.name+" is undefined");return h?0:f}).concat(c.rules.keyvals.map(function(e){var f=y(b[e.name]),h=b[e.name]===void 0||o(f);if(e.required&&h)throw new TypeError("hash: params."+e.name+" is undefined");return h?0:e.name+"="+f})).filter(Boolean).join("/");
if(c.rules.star&&b[c.rules.star])d+=(d[d.length-1]==="/"?"":"/")+b[c.rules.star];return d},last:function(){return x},parse:function(a){var b;a=~a.indexOf("/")?a.slice(a.indexOf("/")):"";if(o(a))throw new TypeError("parse: hash must be a string with a / character");if(!(b=C(a)).length)throw new SyntaxError("parse: "+a+" cannot be parsed");return{page:b[0].page,args:b[0].args}},post_add:function(a){return a},pre_dispatch:function(a){return a},prefix:function(a){return t=a+""||typeof a==="string"?a:
t},remove:function(a){var b=a.method,d=a.route,c=[a.method,a.route].join("|");if([d,b].some(o))throw new TypeError("remove: rule.route and rule.method must both be non-empty strings");if(c in s){a=w(d);delete s[c];j[a.page]=j[a.page].filter(function(e){return e.raw!==d||e.method!==b});if(!j[a.page].length&&delete j[a.page])if(~(a=q.indexOf(a.page)))q.splice(a,1)}}}})(typeof exports==="undefined"?window:exports,"RouteMap");
