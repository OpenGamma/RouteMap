(function(w,x){(function(a,b){if(!a.every||!a.filter||!a.indexOf||!a.map||!a.reduce||!a.some||!a.forEach)throw Error("See "+b+" for reference versions of Array.prototype methods available in JS 1.8");})([],"https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/array/");var k,f={},l={},i=[],s=0,o=0,t=encodeURIComponent,u=decodeURIComponent,n="#",y=/\*|:|\?/,z=/(^([^\*:\?]+):\*)|(^\*$)/,A=/^:([^\*:\?]+)(\??)$/,B=/^([^\*:\?]+):(\??)$/,C=/([^/])$/,p=typeof window!=="undefined"?window:{},
h=function(a){return typeof a!=="string"||!a.length},v=function(a){var b=i.filter(function(b){return a.replace(C,"$1/").indexOf(b)===0}).filter(function(a,b){return!b||f[a].some(function(a){return!!a.rules.star})});return!b.length?[]:b.reduce(function(b,d){var e=f[d].map(function(b){var c={},e=b.rules.scalars,m=b.rules.keyvals,f,g=a.replace(d,"").split("/").reduce(function(a,b){var c=b.split("="),e=c[0],c=c.slice(1).join("=");return!b.length||(c?a.keyvals[e]=c:a.scalars.push(b)),a},{keyvals:{},scalars:[]}),
j,h=m.reduce(function(a,b){return(a[b.name]=0)||a},{}),i=e.filter(function(a){return a.required}).length,l=m.filter(function(a){return a.required}).every(function(a){return g.keyvals.hasOwnProperty(a.name)});if(i>g.scalars.length||!l)return 0;if(!b.rules.star){if(g.scalars.length>e.length)return 0;for(j in g.keyvals)if(g.keyvals.hasOwnProperty(j)&&!h.hasOwnProperty(j))return 0}g.scalars.slice(0,e.length).forEach(function(a,b){c[e[b].name]=u(a)});m.forEach(function(a){g.keyvals[a.name]&&(c[a.name]=
u(g.keyvals[a.name]));delete g.keyvals[a.name]});if(b.rules.star){m=g.scalars.slice(e.length,g.scalars.length);for(j in g.keyvals)g.keyvals.hasOwnProperty(j)&&m.push([j,g.keyvals[j]].join("="));c[b.rules.star]=m.join("/")}try{if(f=b.method.split(".").reduce(function(a,b){return a[b]},p),typeof f!=="function")throw Error();}catch(n){throw new TypeError("parse: "+b.method+" is not a function in current context");}return{page:d,hash:k.hash({route:b.raw},c),method:f,args:c}});return b.concat(e).filter(Boolean)},
[]).sort(function(a,b){return b.hash.length-a.hash.length})},r=function(a){return function(b){var c,d={},e=b[0]==="/"?b:~(c=b.indexOf("/"))?b.slice(c):0,q=function(a){if(d.hasOwnProperty(a)||(d[a]=0))throw new SyntaxError('compile: "'+a+'" is repeated in: '+b);};if(!e)throw new SyntaxError("compile: the route "+b+" was not understood");if(a[e])return a[e];c=e.split("/").reduce(function(a,c){var e=a.rules,d=e.scalars,g=e.keyvals;if(e.star)throw new SyntaxError("compile: no rules can follow a * directive in: "+
b);if(!~c.search(y)&&!d.length&&!g.length)return a.page.push(c),a;if(c.match(z))return e.star=RegExp.$2||RegExp.$3,q(e.star),a;if(c.match(A)){if(a.has_optional_scalar)throw new SyntaxError('compile: "'+c+'" cannot follow an optional rule in: '+b);if(RegExp.$2)a.has_optional_scalar=c;return d.push({name:RegExp.$1,required:!RegExp.$2}),q(RegExp.$1),a}if(c.match(B))return g.push({name:RegExp.$1,required:!RegExp.$2}),q(RegExp.$1),a;throw new SyntaxError('compile: the rule "'+c+'" was not understood in: '+
b);},{page:[],rules:{scalars:[],keyvals:[],star:!1},has_optional_scalar:""});delete c.has_optional_scalar;c.page=c.page.join("/").replace(/\/$/,"")||"/";return a[e]=c}}({});w[x]=k={add:function(a){var b=a.method,c=a.route,d=[a.method,a.route].join("|");if([c,b].some(h))throw new TypeError("add: rule.route and rule.method must both be non-empty strings");if(l[d])throw Error("add: "+c+" to "+b+" already exists");a=r(c);l[d]=!0;if(!f[a.page]&&(f[a.page]=[]))i=i.concat(a.page).sort(function(a,b){return b.length-
a.length});f[a.page].push(k.post_add({method:b,rules:a.rules,raw:c}))},context:function(a){return p=typeof a==="object"?a:p},current:function(){return o},default_handler:function(){},get:function(){if(typeof window==="undefined")return"/";var a=window.location.hash,b=a.indexOf("/");return~b?a.slice(b):"/"},go:function(a){if(typeof window!=="undefined")window.location.hash=(a.indexOf(n)===0?"":n)+a},handler:function(){var a=k.get(),b=v(a),c=Array.prototype.slice.call(arguments);if(!b.length)return k.default_handler.apply(null,
[a].concat(c));o=b[0];b=k.pre_dispatch(b);o=b[0];b.forEach(function(a){a.method.apply(null,[a.args].concat(c))});s=b[0]},hash:function(a,b){var c,d,b=b||{};if(h(a.route))throw new TypeError("hash: rule.route must be a non-empty string");d=r(a.route);c=d.page+(d.page==="/"?"":"/")+d.rules.scalars.map(function(c){var d=t(b[c.name]),f=b[c.name]===void 0||h(d);if(c.required&&f)throw new TypeError("hash: params."+c.name+" is undefined, route: "+a.route);return f?0:d}).concat(d.rules.keyvals.map(function(c){var d=
t(b[c.name]),f=b[c.name]===void 0||h(d);if(c.required&&f)throw new TypeError("hash: params."+c.name+" is undefined, route: "+a.route);return f?0:c.name+"="+d})).filter(Boolean).join("/");d.rules.star&&b[d.rules.star]&&(c+=(c[c.length-1]==="/"?"":"/")+b[d.rules.star]);return c},last:function(){return s},parse:function(a){var b;b=a.indexOf("/");a=~b?a.slice(b):"";if(h(a))throw new TypeError("parse: hash must be a string with a / character");if(!(b=v(a)).length)throw new SyntaxError("parse: "+a+" cannot be parsed");
return{page:b[0].page,args:b[0].args}},post_add:function(a){return a},pre_dispatch:function(a){return a},prefix:function(a){return n=typeof a!=="undefined"?a+"":n},remove:function(a){var b=a.method,c=a.route,d=[a.method,a.route].join("|"),e;if([c,b].some(h))throw new TypeError("remove: rule.route and rule.method must both be non-empty strings");l[d]&&(a=r(c),delete l[d],f[a.page]=f[a.page].filter(function(a){return a.raw!==c||a.method!==b}),!f[a.page].length&&delete f[a.page]&&~(e=i.indexOf(a.page))&&
i.splice(e,1))}}})(typeof exports==="undefined"?window:exports,"RouteMap");
